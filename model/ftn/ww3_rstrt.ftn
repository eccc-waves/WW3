#include "w3macros.h"
!/ ------------------------------------------------------------------- /
   PROGRAM W3RSTRT
!/
!/                  +-----------------------------------+
!/                  | WAVEWATCH III           NOAA/NCEP |
!/                  |         Benoit Pouliot            |
!/                  |                        FORTRAN 90 |
!/                  | First version:        17-Apr-2020 |
!/                  +-----------------------------------+
!/
!/    17-Apr-2020 :  Original Code (from ww3_upstr)      ( version 7.xx )
!/
!/    Copyright 2010 National Weather Service (NWS),
!/    National Oceanic and Atmospheric Administration.  All rights
!/    reserved.  WAVEWATCH III is a trademark of the NWS.
!/    No unauthorized use without permission.
!/
!  1. Purpose :
!
!     Update the WAVEWATCH III restart files start time
!     For some climate run with no leap year
!     
!  2. Method :
!     
!  2.1. General:
!     The W3RSTRT reads the restart file, edits the date and write it back
!     as is.
!
! -------------------------------------------------------------------- $
! WAVEWATCH III Restart time update                                    $
! -------------------------------------------------------------------- $
!
! Time of Update ----------------------------------------------------- $
! - Starting time in yyyymmdd hhmmss format.
!
! This is the new time and has to be the same with
! the time at the restart.ww3.
!
!   19680607 120000 
!
! -------------------------------------------------------------------- $
! WAVEWATCH III EoF ww3_rstrt.inp
! -------------------------------------------------------------------- $
!
!        iii. restart.ww3
! The restart file as came out of the background run, the name has to be 
! restart.ww3, but the name of the output depends on the mod_def.ww3, the
! ww3_rstrt follows its content (be careful with ovewriting).
!
!  3. Example 
!
!  4. Parameters :
!
!     Local parameters.
!     ----------------------------------------------------------------
!
!     ----------------------------------------------------------------
!
!  5. Subroutines used :
!
!      Name      Type  Module   Description
!     ----------------------------------------------------------------
!      W3NMOD    Subr. W3GDATMD Set number of model.
!      W3SETG    Subr.   Id.    Point to selected model.
!      W3NDAT    Subr. W3WDATMD Set number of model for wave data.
!      W3SETW    Subr.   Id.    Point to selected model for wave data.
!      W3NINP    Subr. W3IDATMD Set number of grids/models.
!      W3SETI    Subr.   Id.    Point to data structure.
!      W3DIMI    Subr.   Id.    Set array sizes in data structure.
!      W2NAUX    Subr. W3ADATMD Set number of model for aux data.
!      W3SETA    Subr.   Id.    Point to selected model for aux data.
!      ITRACE    Subr. W3SERVMD Subroutine tracing initialization.
!      NEXTLN    Subr.   Id.    Get next line from input file.
!      EXTCDE    Subr.   Id.    Abort program as graceful as possible.
!      W3IOGR    Subr. W3IOGRMD Reading/writing model definition file.
!      WAVNU1    Subr. W3DISPMD 

!     ----------------------------------------------------------------
!  Internal Subroutines:
!
!  6. Called by :
!
!     None, stand-alone program.
!
!  7. Error messages :
!
!  8. Remarks:
!
!  9. Structure :
!
!     ----------------------------------------------------
!     1.    Set up data structures.
!     2.    Read model defintion file with base model ( W3IOGR )
!     3.    Import restart file                       ( W3IORS )
!     5.    Apply correction to the restart date      (  )
!     6.    Export the updated restart file           ( W3IORS )
!     ----------------------------------------------------
!
!  10. Switches :
!
!     !/SHRD  Switch for shared / distributed memory architecture.
!     !/T
!     !/S     Enable subroutine tracing.
!
! 11. Known Bugs
!
!     1. Fix the format for the output (NSDO) of non strings, e.g. for
!     TIME. 
!
! 12. Source code :
!
!/
      USE W3GDATMD, ONLY: W3NMOD, W3SETG
      USE W3WDATMD, ONLY: W3NDAT, W3SETW
      USE W3ADATMD, ONLY: W3NAUX, W3SETA
      USE W3ODATMD, ONLY: W3NOUT, W3SETO
      USE W3IORSMD, ONLY: W3IORS
      USE W3SERVMD, ONLY: ITRACE, NEXTLN, EXTCDE
      USE W3IOGRMD, ONLY: W3IOGR
!      USE W3DISPMD, ONLY: WAVNU1
!
!      USE W3GDATMD, ONLY: GNAME, NX, NY, MAPSTA, SIG, NK, NTH, NSEA,  &
!                          NSEAL, MAPSF, DMIN, ZB, DSIP, DTH
      USE W3GDATMD, ONLY: GNAME, SIG, NK, NSEA, NSEAL
!      USE W3WDATMD, ONLY: VA, TIME
      USE W3WDATMD, ONLY: TIME
!      USE W3ADATMD, ONLY: NSEALM
      USE W3ODATMD, ONLY: IAPROC, NAPERR, NAPLOG, NDS, NAPOUT
!      USE W3ODATMD, ONLY: NDSE, NDSO, NDST, IDOUT, FNMPRE  
      USE W3ODATMD, ONLY: NDSE, NDSO, FNMPRE  
!/WRST      USE W3IDATMD
!
      IMPLICIT NONE
!/
!/ ------------------------------------------------------------------- /
!  Local variables
!/
      INTEGER                 :: NDSI, NDSM, NDSTRC, NTRACE, IERR, I, J
      CHARACTER               :: COMSTR*1 
!
!      REAL, ALLOCATABLE       :: BETAW(:)
!      LOGICAL, ALLOCATABLE    :: MASK(:)
      LOGICAL                 :: anl_exists, CORWSEA
      INTEGER                 :: IMOD, INTYPE, NDSEN, IX, IY, IK, ITH, &
                                 IXW, IYW
      REAL, ALLOCATABLE       :: UPDPRCNT(:,:),VATMP(:), HSIG(:,:),     &
                                 A(:), HS_ANAL(:,:), gues(:,:),         &
                                 HS_DIF(:,:),SWHANL(:,:), SWHBCKG(:,:), &
                                 SWHUPRSTR(:,:),VATMP_NORM(:),          &
                                 WSBCKG(:,:),WDRBCKG(:,:)
      INTEGER, ALLOCATABLE    :: VAMAPWS(:)
      REAL                    :: PRCNTG, PRCNTG_CAP, THRWSEA
      INTEGER                 :: ROWS, COLS, ISEA
      INTEGER                 :: TIMEOUT(2)
      CHARACTER(128)          :: FLNMCOR, FLNMANL
      CHARACTER(16)           :: UPDPROC
!     for howv
      REAL                    :: SWHTMP,SWHBCKG_1, SWHANL_1,            &
                                 DEPTH, WN, CG, ETOT, E1I,              &
                                 SWHTMP1,SUMVATMP, SWHBCKG_W, SWHBCKG_S
      REAL                    :: K
      CHARACTER(8), PARAMETER :: MYNAME='W3RSTRT'
      LOGICAL                 :: SMCGRD = .FALSE.
      LOGICAL                 :: SMCWND = .FALSE.
      LOGICAL                 :: WRSTON = .FALSE.
!/
!/ ------------------------------------------------------------------- /
!/
!  1.  IO set-up.
      CALL W3NMOD ( 1, 6, 6 )
      CALL W3SETG ( 1, 6, 6 )
      CALL W3NDAT (    6, 6 )
      CALL W3SETW ( 1, 6, 6 )
      CALL W3NAUX (    6, 6 )
      CALL W3SETA ( 1, 6, 6 )
      CALL W3NOUT (    6, 6 )
      CALL W3SETO ( 1, 6, 6 )
!/WRST      CALL W3NINP (    6, 6 )
!/WRST      CALL W3SETI ( 1, 6, 6 )
!
      NDSE   = 6
      NDSI   = 10
      NDSM   = 20
!
      IAPROC = 1
      NAPOUT = 1
      NAPERR = 1
      IMOD   = 1
      NAPLOG = 1
!
      NDSTRC =  6
      NTRACE = 10
      CALL ITRACE ( NDSTRC, NTRACE )
!
      IF ( IAPROC .EQ. NAPERR ) THEN
          NDSEN  = NDSE
      ELSE
          NDSEN  = -1
      END IF
!
      WRITE (NDSO,900)
!
!
!/WRST      !Compiling with WRST will allow access to options UPD5/6
!/WRST      WRSTON = .TRUE.
!/WRST      WRITE (NDSO,*) '*** UPRSTR will read wind from restart files'
!/SMC      !Compiling with SMC option activates SMC grid logicals
!/SMC      SMCGRD = .TRUE.
!/SMC      SMCWND = .TRUE.
!/WRST      ! Override SMCWND - at present restarts only store wind on
!/WRST      ! a regular grid
!/WRST      SMCWND = .FALSE.
!/SMC      WRITE (NDSO,*) '*** UPRSTR set to work with SMC grid model'
!/
!/ ------------------------------------------------------------------- /
!  2. Read the ww3_rstrt.inp
!/
      J      = LEN_TRIM(FNMPRE)
      OPEN (NDSI,FILE=FNMPRE(:J)//'ww3_rstrt.inp',STATUS='OLD',       &
            ERR=800,IOSTAT=IERR)
      READ (NDSI,'(A)',END=801,ERR=802) COMSTR
      IF (COMSTR.EQ.' ') COMSTR = '$'
      WRITE (NDSO,901) COMSTR
!
      CALL NEXTLN ( COMSTR , NDSI , NDSEN )
      READ (NDSI,*,END=2001,ERR=2002) TIME
      CALL NEXTLN ( COMSTR , NDSI , NDSEN )
      READ (NDSI,*,END=2001,ERR=2002) TIMEOUT
!/T      WRITE (NDSO,*)' TIME: ',TIME
!/T      WRITE (NDSO,1004)' FLNMANL: ', trim(FLNMANL), &
!/T                       ' UPDPROC: ', trim(UPDPROC)
!/T      WRITE (NDSO,*)' PRCNTG: ', PRCNTG
!/
!/ ------------------------------------------------------------------- /
!  3.  Read model definition file.
!/
      CALL W3IOGR ( 'READ', NDSM )
      NSEAL  = NSEA
      WRITE (NDSO,920) GNAME
!/
!/ ------------------------------------------------------------------- /
!  4. Read restart file
!/
!/WRST      ! Set the wind flag to true when reading restart wind
!/WRST      INFLAGS1(3) = .TRUE.
!/WRST      CALL W3DIMI ( 1, 6, 6 ) !Needs to be called after w3iogr to have correct dimensions?
      CALL W3IORS ( 'READ', NDS(6), SIG(NK), INTYPE, IMOD )!
      IF ( IAPROC .EQ. NAPLOG ) THEN
         IF (INTYPE.EQ.0.OR.INTYPE.EQ.1.OR.INTYPE.EQ.4) THEN
            WRITE (NDSO,1004) 'Terminating ww3_rstrt: The restart ' // &
                               'file is not read'
            CALL EXTCDE ( 1 )
         ELSE
            WRITE (NDSO,1004) 'Updating Restart File'
         END IF
      END IF
!/
!/ ------------------------------------------------------------------- /
! 5. Update restart file date
! TODO
  TIME(1) = TIMEOUT(1)
  TIME(2) = TIMEOUT(2)
!/
!/
!/ ------------------------------------------------------------------- /
! 6. Write updated restart file
!/
!/WRST      ! Copy read wind values from restart for write out
!/WRST      WXN = WXNwrst
!/WRST      WYN = WYNwrst
      WRITE (NDSO,903)
      INTYPE = 3
      CALL W3IORS ( 'HOT', NDS(6), SIG(NK), INTYPE, 1 )   
! 
!/
!/ ------------------------------------------------------------------- /
! Escape locations read errors 08k:
!/
      GOTO 888
!
      800 CONTINUE
      WRITE (NDSE,1000) IERR
      CALL EXTCDE ( 10 )
!
      801 CONTINUE
      WRITE (NDSE,1001)
      CALL EXTCDE ( 11 )
!
      802 CONTINUE
      WRITE (NDSE,1002) IERR
      CALL EXTCDE ( 12 )
! 
      888 CONTINUE
      WRITE (NDSO,999)
!/
!/ ------------------------------------------------------------------- /
! Escape locations read errors 2k:
!/
      GOTO 2222
!
      2001 CONTINUE
      IF ( IAPROC .EQ. NAPERR ) WRITE (NDSE,1001)
      GOTO 2222
!
      2002 CONTINUE
      IF ( IAPROC .EQ. NAPERR ) WRITE (NDSE,1002) IERR
      GOTO 2222
!
      2222 CONTINUE
!/
!/ ------------------------------------------------------------------- /
!  Formats
!/
900 FORMAT (/15X,'   *** WAVEWATCH III ww3_rstrt Initializing ***   '/ &
             15X,'  ==============================================='/)
901 FORMAT ( '  Comment character is ''',A,''''/)
!
903 FORMAT ( '  Exporting the Updated Restart file to "restart001.ww3"'/)
!
920 FORMAT ( '  Grid name : ',A/)
!
999 FORMAT (/'  End of program '/                                   &
             ' ========================================='/          &
             '         WAVEWATCH III ww3_rstrt          '/)
!
1000 FORMAT (/' *** WAVEWATCH III ERROR IN W3RSTRT : '/              &
               '     ERROR IN OPENING INPUT FILE'/                    &
               '     IOSTAT =',I5/)
!
1001 FORMAT (/' *** WAVEWATCH III ERROR IN W3RSTRT : '/               &
               '     PREMATURE END OF INPUT FILE'/)

1002 FORMAT (/' *** WAVEWATCH III ERROR IN W3RSTRT : '/              &
               '     ERROR IN READING FROM INPUT FILE'/               &
               '     IOSTAT =',I5/)
1004 FORMAT (/' '/,A/)
!     
!/
!/ ------------------------------------------------------------------- /
!/
   END PROGRAM W3RSTRT
